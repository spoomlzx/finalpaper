\chapter{仿真实验与结果分析}
\begin{lstlisting}[language=C]
void Ch::handleMessage(cMessage* msg) {
    //cluster header
    if (getIndex() == 0) {
        if (msg == sendPkt) {
            //generate packet of event
            char msgname[30];
            sprintf(msgname,"event @ %s",SIMTIME_STR(simTime()));
            ev<<"simtime:"<<simTime()<<endl;
            eventPkt->setName(msgname);
            eventPkt->setSource(getIndex());
            eventPkt->setHopCount(hopCount);
            eventPkt->setXmac(eventPkt->getEvent()-123);
            eventPkt->setBitLength(pkLenBits->longValue());
            int n = gateSize("radio");
            send(eventPkt,"radio$o",n-1);
            eventPkt=new PacketCh("");
            scheduleAt(simTime() + radioDelay, sendPkt);
        } else {
            PacketCn *pkt = check_and_cast<PacketCn *>(msg);
            int src = pkt->getSource();
            int event = pkt->getEvent();
            ev << "from #" << src << "with event:" << event << endl;
            //1011000 仿真中用作简单的mac
            eventPkt->setMac(src,1011000+src);
            eventPkt->setEvent(eventPkt->getEvent()+event);
        }
    }
    //en-route节点
    else {
        int n = gateSize("radio");
        double duration=pkLenBits->longValue()/txRate;
        ev<<"duration time:"<<duration<<endl;
        sendDelayed(msg,duration,"radio$o",n-1);
    }
}
\end{lstlisting}

